name: Auto Create Addon Branch

# 触发条件：仅当推送Tag时触发
on:
  push:
    tags:
      - '*'
  workflow_dispatch:

# 流水线任务配置
jobs:
  create-addon-branch:
    runs-on: ubuntu-latest
    steps:
      # 检出仓库代码（需拉取完整历史，用于分支操作）
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整的仓库历史，避免分支操作失败

      # 配置Git用户信息（流水线提交代码需要身份标识）
      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 提取当前Tag名称（截取refs/tags/后的纯Tag名）
      - name: Get current Tag name
        id: get_tag
        run: |
          # 从github.ref中提取纯Tag名称（github.ref格式为refs/tags/{tagname}）
          TAG_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/tags\///g')
          # 输出Tag名称，供后续步骤使用
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      # 创建并切换到addon-{tagname}分支
      - name: Create and checkout addon branch
        run: |
          # 定义分支名：addon-拼接Tag名称
          BRANCH_NAME="addon-${{ steps.get_tag.outputs.tag_name }}"
          # 检查分支是否已存在，若存在则先切换并拉取最新代码；若不存在则创建新分支
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists, checkout and pull latest code"
            git checkout $BRANCH_NAME
            git pull origin $BRANCH_NAME
          else
            echo "Create new branch $BRANCH_NAME"
            git checkout -b $BRANCH_NAME
          fi

      # 处理文件（仅保留addons/konado内容，移至根目录，删除其他文件）
      - name: Extract addons/konado content to root directory
        run: |
          # 1. 创建临时目录，备份addons/konado下的所有内容
          mkdir -p ./temp_konado
          cp -r ./addons/konado/* ./temp_konado/

          # 2. 删除当前工作区所有跟踪的文件（保留.git目录，不影响Git仓库）
          git rm -rf . --quiet
          # 3. 删除未被Git跟踪的文件/目录（如临时文件、日志等）
          rm -rf ./*

          # 4. 将临时目录中的内容移回仓库根目录
          cp -r ./temp_konado/* ./
          # 5. 删除临时目录
          rm -rf ./temp_konado

      # 提交更改并推送到addon-{tagname}分支
      - name: Commit and push branch
        run: |
          # 定义分支名和Tag名称
          BRANCH_NAME="addon-${{ steps.get_tag.outputs.tag_name }}"
          TAG_NAME="${{ steps.get_tag.outputs.tag_name }}"

          # 暂存所有更改
          git add .
          # 提交更改（备注信息包含Tag名称，便于追溯）
          git commit -m "chore: push konado content for tag $TAG_NAME" --quiet

          # 推送分支到远程仓库（使用默认GITHUB_TOKEN授权）
          git push origin $BRANCH_NAME