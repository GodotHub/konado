name: Auto Sync Master to Addon-Master

on:
  push:
    branches:
      - master
  workflow_dispatch: # 手动触发支持

jobs:
  sync-to-addon-master:
    runs-on: ubuntu-latest
    steps:
      # 检出仓库代码（拉取完整历史，支持分支操作）
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须拉取完整历史，否则分支查询/切换可能失败

      # 配置Git用户信息（流水线提交需要身份标识）
      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 创建并切换到addon-master分支（修复原有逻辑：存在则拉取最新，不存在则创建）
      - name: Create and checkout addon-master branch
        run: |
          BRANCH_NAME="addon-master"
          # 检查远程是否存在该分支
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists, checkout and pull latest code"
          else
            echo "Create new branch $BRANCH_NAME"
            git checkout -b $BRANCH_NAME # 创建并切换到新分支
          fi

      # 处理文件（保留原有迁移逻辑，无需修改）
      - name: Extract addons/konado content to root directory
        run: |
          # 前置检查：确认目标目录存在
          if [ ! -d "./addons/konado" ]; then
            echo "Error: Directory ./addons/konado does not exist!"
            exit 1
          fi

          # 创建隐藏临时目录（避免被rm -rf ./* 删除）
          mkdir -p ./.temp_konado
          # 复制addons/konado下所有内容（包括隐藏文件、空目录）
          cp -r ./addons/konado/. ./.temp_konado/

          # 删除当前分支所有文件（--quiet静默执行）
          git rm -rf . --quiet
          # 彻底删除工作区非版本控制文件
          rm -rf ./*
          # 从临时目录恢复文件
          cp -r ./.temp_konado/. ./
          # 删除临时目录
          rm -rf ./.temp_konado
        shell: /usr/bin/bash -e {0}

      # 提交更改并推送（核心：先删除远程已有addon-master，再推送新分支）
      - name: Commit and push to addon-master
        run: |
          BRANCH_NAME="addon-master"
          
          # 暂存所有更改
          git add .
          
          # 提交更改（无变更时不报错，仅提示）
          git commit -m "chore: sync master branch content to addon-master" --quiet || echo "No changes to commit"
          
          # 关键步骤：检查远程是否存在addon-master分支，若存在则删除
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Remote branch $BRANCH_NAME exists, deleting it first"
            git push origin --delete $BRANCH_NAME # 删除远程分支
          fi
          
          # 推送本地addon-master分支到远程（此时远程无该分支，直接创建）
          git push origin $BRANCH_NAME